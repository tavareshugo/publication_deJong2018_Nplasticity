---
title: "de Jong et al (2018)"
output:
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Analysis of trait variation

The code in this document reproduces figures 1-4, S1-S2 of the paper. Most figures 
were post-processed in Inkscape. 

```{r, message = FALSE}
library(tidyverse)
library(patchwork)

# Load function used to annotate plots with correlation
source("./functions/corrLabel.R")

# Change ggplot2 default aesthetics
theme_set(theme_classic() + 
            theme(panel.grid = element_blank(), 
                  text = element_text(size = 8),
                  plot.title = element_text(hjust = -0.07, size = 10, face = "bold", 
                                            margin = margin(t = -5, b = 1)),
                  plot.subtitle = element_text(size = 10, hjust = 0.5)))
```


## Read data

There are two main datasets: accessions and MAGIC lines.

For each there are three data files in the `./data/phenotypes` directory (see the 
README on the data directory for more details).

Here, we read the trait data summarised by line, in two different formats 
(because these formats are useful for visualisation in different contexts):

```{r, message = FALSE}
# Read MAGIC line data
magic_sum <- read_rds("../../data/phenotypes/magic_summarised.rds")
magic_plas <- read_rds("../../data/phenotypes/magic_plasticity.rds")

# Read Accession data (note there is also senescence data for this set)
acc_sum <- read_rds("../../data/phenotypes/accessions_summarised.rds") %>% 
  filter(set == "silique")
acc_plas <- read_rds("../../data/phenotypes/accessions_plasticity.rds") %>% 
  filter(set == "silique")

acc_sum_sen <- read_rds("../../data/phenotypes/accessions_summarised.rds") %>% 
  filter(set == "senescence")
acc_plas_sen <- read_rds("../../data/phenotypes/accessions_plasticity.rds") %>% 
  filter(set == "senescence")

# Read variance components created in 01_variance_partitioning.Rmd
all_trait_vars <- read_csv("./temp_data/all_trait_variances.csv")
```


## Natural variation in shoot branching response to nitrate supply

### Figure 1

This picture shows variance components estimated using linear mixed models (see
separate document "01_variance_partitioning.Rmd")

```{r}
#pdf("./figures/figure1.pdf", width = 4.5, height = 2.5)
all_trait_vars %>% 
  mutate(trait = factor(trait, levels = c("bolt", "height", "branches", "branches_sen", "sil_sen")),
         set = factor(set, levels = c("MAGIC lines", "Accessions"))) %>% 
  group_by(set, trait) %>% 
  mutate(variance = variance/sum(variance)*100,
         component = factor(component, levels = c("var_res", "var_plas", "var_nitrate", "var_gen"))) %>% 
  ungroup() %>% 
  ggplot(aes(trait, variance, fill = component, label = round(variance))) +
  geom_bar(stat = "identity", colour = "black") +
  facet_grid(~ set, scales = "free_x", space = "free_x") +
  scale_fill_manual(labels = c("Res", "GxE", "E", "G"),
                    values = c("white", "gray48", "grey", "black")) +
  labs(y = "% variance", x = "Trait") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#dev.off()
```

### Figure 2

This figure shows the correlations between key traits on HN and LN. We also indicate 
Pearson's correlation coeficient in the plots.

```{r figure1}
### MAGIC lines ###
# branches
p1 <- ggplot(magic_plas, aes(totalbr_mean_hn, totalbr_mean_ln)) +
  geom_point() +
  annotate(geom = "text", x = 0, y = 10, 
           label = corLabel(magic_plas$totalbr_mean_hn, magic_plas$totalbr_mean_ln, TRUE),
           hjust = 0, vjust = 1, size = 2.5) +
  coord_cartesian(xlim = c(0, 10), ylim = c(0, 10)) +
  geom_abline(linetype = "dashed") +
  labs(x = "Total Branches (HN)", y = "Total Branches (LN)") +
  scale_x_continuous(breaks = seq(0, 10, 2)) +
  scale_y_continuous(breaks = seq(0, 10, 2))

# Bolt
p2 <- ggplot(magic_plas, aes(bolt_mean_hn, bolt_mean_ln)) +
  geom_point() +
  annotate(geom = "text", x = 10, y = 108, 
           label = corLabel(magic_plas$bolt_mean_hn, magic_plas$bolt_mean_ln, TRUE),
           hjust = 0, vjust = 1, size = 2.5) +
  coord_cartesian(xlim = c(10, 110), ylim = c(10, 110)) +
  geom_abline(linetype = "dashed") +
  labs(x = "Days to Flowering (HN)", y = "Days to Flowering (LN)") +
  scale_x_continuous(breaks = seq(10, 110, 20)) +
  scale_y_continuous(breaks = seq(10, 110, 20))


### Accessions ###
# branches
p3 <- ggplot(acc_plas, aes(totalbr_mean_hn, totalbr_mean_ln)) +
  geom_point() +
  annotate(geom = "text", x = 0, y = 10, 
           label = corLabel(acc_plas$totalbr_mean_hn, acc_plas$totalbr_mean_ln, TRUE),
           hjust = 0, vjust = 1, size = 2.5) +
  coord_cartesian(xlim = c(0, 10), ylim = c(0, 10)) +
  geom_abline(linetype = "dashed") +
  labs(x = "Total Branches (HN)", y = "Total Branches (LN)") +
  scale_x_continuous(breaks = seq(0, 10, 2)) +
  scale_y_continuous(breaks = seq(0, 10, 2))

# Bolt
p4 <- ggplot(acc_plas, aes(bolt_mean_hn, bolt_mean_ln)) +
  geom_point() +
  annotate(geom = "text", x = 10, y = 38, 
           label = corLabel(acc_plas$bolt_mean_hn, acc_plas$bolt_mean_ln, TRUE),
           hjust = 0, vjust = 1, size = 2.5) +
  coord_cartesian(xlim = c(10, 40), ylim = c(10, 40)) +
  geom_abline(linetype = "dashed") +
  labs(x = "Days to Flowering (HN)", y = "Days to Flowering (LN)") +
  scale_x_continuous(breaks = seq(10, 40, 5)) +
  scale_y_continuous(breaks = seq(10, 40, 5))

# Put the plots together and save to pdf
#pdf("./figures/figure2.pdf", width = 5.2, height = 5.2)
p1 + labs(title = "A") + 
  p2 + labs(title = "B") +
  p3 + labs(title = "C") +
  p4 + labs(title = "D") +
  plot_layout(ncol = 2)
#dev.off()
```


### Figure S1

This figure shows the correlation between number of shoot branches at the 2-silique 
and sencescence stages:

```{r}
# Join the silique and senescence tables
temp <- inner_join(acc_sum, acc_sum_sen, by = c("id_leyser", "nitrate")) %>% 
  select(id_leyser, nitrate, matches("totalbr_mean")) %>% 
  rename(totalbr_sil = totalbr_mean.x,
         totalbr_sen = totalbr_mean.y)

# Correlation between traits at silique and senescence stages
cor_sil_sen <- data.frame(nitrate = c("HN", "LN"),
                          cor = c(corLabel(temp$totalbr_sil[temp$nitrate == "HN"], 
                                           temp$totalbr_sen[temp$nitrate == "HN"], 
                                           TRUE,
                                           use = "complete.obs"),
                                  corLabel(temp$totalbr_sil[temp$nitrate == "LN"], 
                                           temp$totalbr_sen[temp$nitrate == "LN"], 
                                           TRUE, 
                                           use = "complete.obs")))

# Figure
#pdf("./figures/figureS1.pdf", width = 5.2, height = 5)
temp %>% 
  ggplot(aes(totalbr_sil, totalbr_sen)) +
  geom_point() +
  geom_text(data = cor_sil_sen, x = 0, y = 7, aes(label = cor), size = 2.5, hjust = 0) +
  geom_abline(linetype = "dashed") +
  facet_wrap(~ nitrate) +
  labs(x = "Total Branches (silique)", y = "Total Branches (senescence)")
#dev.off()
```

This plot (not included in the paper) shows the difference between number of 
shoot branches at the 2-silique and senescence stages:

```{r}
temp %>% 
  mutate(branches = totalbr_sen - totalbr_sil) %>% 
  ggplot() +
  geom_histogram(aes(branches), fill = "grey") +
  geom_text(data = cor_sil_sen, x = 2, y = 120, aes(label = cor), size = 3) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  facet_wrap(~ nitrate) +
  labs(x = "Difference in Total Branches\n(senescence - silique)")

rm(temp, cor_sil_sen)
```

This makes the same plot as above but only for those cases where the same 
number of lines was observed in both silique and senescence stage:

```{r}
inner_join(acc_sum, acc_sum_sen, by = c("id_leyser", "nitrate", "totalbr_n")) %>% 
  select(id_leyser, nitrate, matches("totalbr_mean")) %>% 
  ggplot(aes(totalbr_mean.x, totalbr_mean.y)) +
  geom_point() +
  facet_grid(~ nitrate) +
  geom_abline()
```

### Figure S2

This section explores the correlation between silique number and seed yield:

```{r}
# Read seed yield data
seeds <- read_csv("../../data/seed_yield/seed_yield.csv")

# Summarise data with means
seeds_sum <- seeds %>% 
  mutate(seedwgt = seedwgt*1000) %>% # convert weight to mg
  group_by(id_leyser, nitrate) %>% 
  summarise_at(vars(shootwgt, seedwgt, totalsil, totalbr), 
               funs(mean, sd, se = sd(.)/sqrt(n()))) %>% 
  ungroup() %>% 
  mutate(set = ifelse(str_detect(id_leyser, "accession"), "accession", "MAGIC"))
```

We can visualise the sample size in each group:

```{r}
seeds %>% 
  count(id_leyser, nitrate) %>% 
  ggplot(aes(nitrate, id_leyser)) +
  geom_tile(colour = "black", fill = "white") + geom_text(aes(label = n))
```


We can visualise all data (for each individual, with several replicates per line):

```{r}
ggplot(seeds, aes(totalbr, totalsil)) + geom_point()
ggplot(seeds, aes(totalsil, seedwgt)) + geom_point()
```

We report the data summarised per line and separately for HN and LN (showing 2x 
standard error):

```{r}
# Relationship between siliques number and seed weight
p1 <- ggplot(seeds_sum, aes(totalsil_mean, seedwgt_mean, colour = nitrate)) +
  geom_point(aes(shape = set)) +
  geom_errorbar(aes(ymin = seedwgt_mean - 2*seedwgt_se, ymax = seedwgt_mean + 2*seedwgt_se)) +
  geom_errorbarh(aes(xmin = totalsil_mean - 2*totalsil_se, xmax = totalsil_mean + 2*totalsil_se)) +
  annotate(geom = "text", x = 25, y = 70, size = 2.5,
           label = corLabel(seeds_sum$totalsil_mean, seeds_sum$seedwgt_mean, TRUE),
           hjust = 0) +
  scale_colour_manual(values = c("black", "grey")) +
  labs(x = "Total Siliques", y = "Seed weight (mg)", colour = "Nitrate") +
  theme(legend.position = c(1, 0.1), legend.justification = c(1, 0.1)) +
  scale_shape_manual(values = c(19, 4))

# Relationship between branch number and seed weight
p2 <- ggplot(seeds_sum, aes(totalbr_mean, seedwgt_mean, colour = nitrate)) +
  geom_point(aes(shape = set)) +
  geom_errorbar(aes(ymin = seedwgt_mean - 2*seedwgt_se, ymax = seedwgt_mean + 2*seedwgt_se), width = 0) +
  geom_errorbarh(aes(xmin = totalbr_mean - 2*totalbr_se, xmax = totalbr_mean + 2*totalbr_se), height = 0) +
  annotate(geom = "text", x = 0, y = 70, size = 2.5,
           label = corLabel(seeds_sum$totalbr_mean, seeds_sum$seedwgt_mean, TRUE),
           hjust = 0) +
  scale_colour_manual(values = c("black", "grey")) +
  labs(x = "Total Branches", y = "Seed weight (mg)") +
  theme(legend.position = "none") +
  scale_shape_manual(values = c(19, 4))

# Relationship between branch number and silique number at senescence stage
p3 <- ggplot(acc_sum_sen, aes(totalbr_mean, totalsil_mean, colour = nitrate)) +
  geom_point() +
  annotate(geom = "text", x = 0, y = 200, size = 2.5, hjust = 0, 
           label = corLabel(acc_sum_sen$totalbr_mean, acc_sum_sen$totalsil_mean, TRUE)) +
  labs(x = "Total Branches", y = "Total Siliques") +
  scale_colour_manual(values = c("black", "grey")) +
  theme(legend.position = c(1, 1), legend.justification = c(1,1))

# Putting plots together
#pdf("./figures/figureS2.pdf", width = 5.2, height = 5.2)
p2 + ggtitle("A") +
  p1 + ggtitle("B") +
  p3 + ggtitle("C") +
  plot_layout(ncol = 2)
#dev.off()
```


### deprecated figure - removed from final version of the paper

This figure schematically illustrates different patterns of correlation between 
a trait in two environments and how it relates to plasticity.

```{r}
# Create some mock data
x <- data.frame(environment = rep(c("Env1", "Env2"), each = 4),
                id = rep(letters[1:4], 2),
                plastic = c(1:4, 6:9),
                divergent = c(1:4, 8, 10, 12, 14),
                convergent = c(1:4, seq(6, 7, length.out = 4)),
                cross = c(1:4, 5.4, 6,3.2, 4.5)) %>% 
  gather("type", "trait", plastic:cross) %>%
  mutate(type = factor(type,  levels = c("plastic", "divergent", "convergent", "cross")))

p1 <- x %>%
  ggplot(aes(environment, trait, group = id)) +
  geom_line() +
  geom_point(size = 3, aes(colour = environment)) +
  #stat_summary(fun.data = "mean_se", colour = "red3", aes(group = 1)) +
  facet_wrap(~ type, ncol = 1, scales = "free") +
  scale_colour_manual(values = c("grey", "black")) +
  theme(legend.position = "none", axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

p2 <- x %>% 
  spread(environment, trait) %>%
  mutate(Plasticity = Env2 - Env1) %>%
  gather("environment", "trait", Env1, Env2) %>%
  ggplot(aes(Plasticity, trait, colour = environment)) +
  stat_smooth(method = "lm", se = FALSE) +
  geom_point(size = 3) +
  facet_wrap(~ type, ncol = 1, scales = "free") +
  scale_colour_manual(values = c("grey", "black")) +
  theme(legend.position = "none", axis.title=element_blank(),
        axis.text=element_blank(),
        axis.ticks=element_blank())

p1 + p2 + plot_layout(ncol = 2)
```


## Plasticity is associated with extreme phenotypes and correlates with flowering time

### Figure 3

This figure shows the correlation between shoot branching plasticity and the 
respective values on each nitrate treatment. This illustrates the correlation 
observed in the "random slopes" model produced for Figure 1 
(see code in "01_variance_partitioning.Rmd").

It also shows the correlation between plasticity and flowering time.

**Panel A:**

```{r}
# total branches against plasticity. 
p1 <- ggplot(magic_plas, aes(x = totalbr_mean_D)) +
  geom_point(aes(y = totalbr_mean_hn, colour = "HN"), size = 0.8) +
  geom_point(aes(y = totalbr_mean_ln, colour = "LN"), size = 0.8) +
  annotate(geom = "text", x = 6, y = 4, size = 2.5, hjust = 0,
           label = corLabel(magic_plas$totalbr_mean_D, magic_plas$totalbr_mean_ln)) +
  annotate(geom = "text", x = 6, y = 6, size = 2.5, hjust = 0,
           label = corLabel(magic_plas$totalbr_mean_D, magic_plas$totalbr_mean_hn)) +
  scale_colour_manual(values = c("black", "grey69")) +
  labs(y = "Total Branches", x = "Branching Plasticity", colour = "Nitrate") +
  theme(legend.position = c(0.1, 1), legend.justification = c(0.1, 1))
```

**Panel B:**

```{r}
# Make subset of extremes using earlier flowering plants 
## (25 on each end of the distribution)
magic_extremes <- magic_plas %>% 
  filter(bolt_mean_ln < 25) %>% 
  arrange(totalbr_mean_D) %>% 
  slice(c(1:25, (n()-24):n())) %>% 
  mutate(plastic_category = rep(c("Least plastic", "Most plastic"), each = 25)) %>% 
  select(id_kover, plastic_category, totalbr_mean_D)

# Join with summary table
magic_extremes <- left_join(magic_extremes, magic_sum, by = "id_kover")

# Boxplot
p2 <- ggplot(magic_extremes, aes(nitrate, totalbr_mean, fill = nitrate)) +
  geom_boxplot(size = 0.8, width = 1) +
  scale_fill_manual(values = c("white", "grey69")) +
  labs(x = "Nitrate", y = "Total Branches") +
  facet_grid(~ plastic_category) +
  theme(legend.position = "none")
```

**Panel C:**

```{r}
# Correlation with flowering time
# Also add the correlation for different sets of the data
# And highlight the two lines that are used for later experiments
p3 <- ggplot(magic_plas, aes(bolt_mean_ln, totalbr_mean_D)) +
  geom_point(size = 0.8) +
  geom_vline(xintercept = 25, linetype = "dotted") +
  annotate(geom = "text", x = 26, y = 8, size = 2.5, hjust = 0, vjust = 1,
           label = corLabel(magic_plas$bolt_mean_ln, magic_plas$totalbr_mean_D)) +
  annotate(geom = "text", x = 12, y = 8, size = 2.5, hjust = 0, vjust = 1,
           label = with(filter(magic_plas, bolt_mean_ln < 25),
                        corLabel(bolt_mean_ln, totalbr_mean_D))) +
  stat_smooth(se = FALSE, method = "loess") +
  labs(x = "Days to Flowering (LN)", y = "Branching Plasticity") +
  scale_x_continuous(breaks = seq(10, 100, 10))
```

Put plots together:

```{r}
#pdf("./figures/figure3.pdf", width = 5.2, height = 4)
{p1 + ggtitle("A") +
    p2 + ggtitle("B")} /
  p3 + ggtitle("C")
#dev.off()
```


Panel B was further annotated with the mean flowering time for each of the 
groups, given below:

```{r}
magic_extremes %>% 
  group_by(plastic_category) %>% 
  summarise(mean = mean(bolt_mean),
            sd = sd(bolt_mean),
            median = median(bolt_mean),
            q1 = quantile(bolt_mean, 0.25),
            q2 = quantile(bolt_mean, 0.75))
```

Number of lines in total or under 25 days of flowering:

```{r}
sum(!is.na(magic_plas$bolt_mean_ln))
sum(magic_plas$bolt_mean_ln < 25)
```



### Figure 4

This is similar to Figure 3, but with an added panel showing the correlation 
between plasticity and fruit number. 

**Panel A:**

```{r figure4A}
# Plot of total branches against plasticity. 
# Add Pearson's correlation to the plot
p1 <- ggplot(acc_plas, aes(x = totalbr_mean_D)) +
  geom_point(aes(y = totalbr_mean_hn, colour = "HN"), size = 0.8) +
  geom_point(aes(y = totalbr_mean_ln, colour = "LN"), size = 0.8) +
  annotate(geom = "text", x = 5, y = 2, size = 2.5, hjust = 0,
           label = corLabel(acc_plas$totalbr_mean_D, acc_plas$totalbr_mean_ln)) +
  annotate(geom = "text", x = 5, y = 5, size = 2.5, hjust = 0,
           label = corLabel(acc_plas$totalbr_mean_D, acc_plas$totalbr_mean_hn)) +
  scale_colour_manual(values = c("black", "grey69")) +
  labs(y = "Total Branches", x = "Branching Plasticity", colour = "Nitrate") +
  theme(legend.position = c(0.1, 1), legend.justification = c(0.1, 1))
```


**Panel B:**

```{r figure4B}
# Make subset of extremes (25 on each end of the distribution)
acc_extremes <- acc_plas %>% 
  filter(bolt_mean_ln < 25) %>% 
  arrange(totalbr_mean_D) %>% 
  slice(c(1:25, (n()-24):n())) %>% 
  mutate(plastic_category = rep(c("Least plastic", "Most plastic"), each = 25)) %>% 
  select(id_leyser, plastic_category, totalbr_mean_D)

# Join with summary table
acc_extremes <- left_join(acc_extremes, acc_sum, by = "id_leyser")

# Boxplots
p2 <- ggplot(acc_extremes, aes(nitrate, totalbr_mean, fill = nitrate)) +
  geom_boxplot(size = 0.8, width = 2) +
  scale_fill_manual(values = c("white", "grey69")) +
  labs(x = "Nitrate", y = "Total Branches") +
  facet_grid(~ plastic_category) +
  theme(legend.position = "none")
```

**Panel C:**

```{r figure4C}
# Plot of total siliques against plasticity. 
p3 <- ggplot(acc_plas_sen, aes(x = totalbr_mean_D)) +
  geom_point(aes(y = totalsil_mean_hn, colour = "HN"), size = 0.8) +
  geom_point(aes(y = totalsil_mean_ln, colour = "LN"), size = 0.8) +
  annotate(geom = "text", x = 5, y = 55, size = 2.5, hjust = 0, vjust = 1,
           label = corLabel(acc_plas_sen$totalbr_mean_D, acc_plas_sen$totalsil_mean_ln)) +
  annotate(geom = "text", x = 5, y = 170, size = 2.5, hjust = 0, vjust = 1,
           label = corLabel(acc_plas_sen$totalbr_mean_D, acc_plas_sen$totalsil_mean_hn)) +
  scale_colour_manual(values = c("black", "grey69")) +
  labs(y = "Total Siliques", x = "Branching Plasticity", colour = "Nitrate") +
  theme(legend.position = "none")
```


**Panel D:**

```{r figure4D}
# Correlation with flowering time
# Also add the correlation for different sets of the data
p4 <- ggplot(acc_plas, aes(bolt_mean_ln, totalbr_mean_D)) +
  geom_point(size = 0.8) +
  geom_vline(xintercept = 25, linetype = "dotted") +
  annotate(geom = "text", x = 26, y = 8, size = 2.5, hjust = 0, vjust = 1,
           label = corLabel(acc_plas$bolt_mean_ln, acc_plas$totalbr_mean_D)) +
  annotate(geom = "text", x = 15, y = 8, size = 2.5, hjust = 0, vjust = 1,
           label = with(filter(acc_plas, bolt_mean_ln < 25),
                        corLabel(bolt_mean_ln, totalbr_mean_D))) +
  stat_smooth(se = FALSE, method = "loess") +
  labs(x = "Days to Flowering (LN)", y = "Branching Plasticity") +
  scale_x_continuous(breaks = seq(10, 100, 10))
```

Putting the whole figure together

```{r figure4}
#pdf("./figures/figure4.pdf", width = 5.2, height = 4)
{p1 + ggtitle("A") +
    p2 + ggtitle("B")} /
    {p3 + ggtitle("C") +
      p4 + ggtitle("D")}
#dev.off()
```

The mean flowering time for each of the groups in Panel B is given below:

```{r}
acc_extremes %>% 
  group_by(plastic_category) %>% 
  summarise(mean = mean(bolt_mean),
            sd = sd(bolt_mean),
            median = median(bolt_mean),
            q1 = quantile(bolt_mean, 0.25),
            q2 = quantile(bolt_mean, 0.75))
```

How many lines in total or under 25 days of flowering:

```{r}
sum(!is.na(acc_plas$bolt_mean_ln))
sum(acc_plas$bolt_mean_ln < 25)
```

### Extra

This was not included in the paper, but it shows the relationship between 
plasticity and average fruit yield - this shows that plasticity 
itself is not adaptive:

```{r}
acc_plas_sen %>% 
  mutate(mean_sil = (totalsil_mean_hn + totalsil_mean_ln)/2) %>% 
  ggplot(aes(totalbr_mean_D, mean_sil)) +
  geom_point() +
  geom_hline(aes(yintercept = mean(mean_sil))) +
  geom_vline(aes(xintercept = mean(totalbr_mean_D))) +
  stat_smooth(method = "lm", se = FALSE)
```



# Session info

```{r}
sessionInfo()
```

