---
title: "de Jong et al (2018)"
output:
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Analysis of N-pulse experiments

This document provides with the code to analyse data from two N-pulse experiments.

```{r, message = FALSE}
library(tidyverse)
library(patchwork)

# Load function used to annotate plots with correlation
source("./functions/corrLabel.R")

# Change ggplot2 default aesthetics
theme_set(theme_classic() + 
            theme(panel.grid = element_blank(), 
                  text = element_text(size = 8),
                  plot.title = element_text(hjust = -0.07, size = 10, face = "bold", 
                                            margin = margin(t = -5, b = 1)),
                  plot.subtitle = element_text(size = 10, hjust = 0.5)))
```


## Read data

Below, we read data from the pulse experiments, but also from the QTL experiments, 
so that they can be compared with each other. 

```{r, message = FALSE}
# Read pulse experiment data
pulse_plas <- read_rds("../../data/pulse/pulse_summary_wide.rds") %>% 
  mutate(experiment = plyr::mapvalues(experiment, c("2015.02", "2017.09"), c("Experiment 1", "Experiment 2"))) %>% 
  rename_all(funs(str_replace(., "_mean_", "_pulse_")))

# Read MAGIC line data - for comparison with pulse experiment
magic_plas <- read_rds("../../data/phenotypes/magic_plasticity.rds") %>% 
  filter(id_kover %in% pulse_plas$id_public) %>% 
  select(id_kover, totalbr_mean_ln, totalbr_mean_hn, height_mean_ln, height_mean_hn, bolt_mean_ln, bolt_mean_hn) %>% 
  rename_all(funs(str_replace(., "_mean_", "_qtl_"))) %>% 
  rename(id_public = id_kover)

# Read Accession data - for comparison with pulse experiment
acc_plas <- read_rds("../../data/phenotypes/accessions_plasticity.rds") %>% 
  filter(set == "silique" & name %in% pulse_plas$id_public & id_leyser %in% pulse_plas$id_leyser) %>% 
  select(name, totalbr_mean_ln, totalbr_mean_hn, height_mean_ln, height_mean_hn, bolt_mean_ln, bolt_mean_hn) %>% 
  rename_all(funs(str_replace(., "_mean_", "_qtl_"))) %>% 
  rename(id_public = name)

# Bind QTL datasets
qtl_plas <- bind_rows(magic_plas, acc_plas)
rm(acc_plas, magic_plas) # remove as no longer needed

# Join to pulse data
## Shorten names of MAGIC lines for plotting
pulse_plas <- inner_join(pulse_plas, qtl_plas, by = "id_public") %>% 
  mutate(id_public = str_replace(id_public, "MAGIC.", "M"))
```

## Fig S3 - Comparison between experiments

The following graph shows that the branching plasticity from the QTL experiment 
is well correlated with experiment 1, but not so much for experiment 2.

It also shows the difference in average branch number between the QTL and Pulse 
experiments.

```{r}
# Get correlation for labeling plots
corr_labels <- pulse_plas %>% 
  group_by(experiment) %>% 
  summarise(x = -1.5,
            y = 7,
            corr_label = corLabel(totalbr_qtl_hn - totalbr_qtl_ln, totalbr_pulse_hn - totalbr_pulse_ln))

p1 <- pulse_plas %>% 
  mutate(x = totalbr_qtl_hn - totalbr_qtl_ln,
         y = totalbr_pulse_hn - totalbr_pulse_ln) %>% 
  ggplot(aes(x, y)) +
  geom_abline(linetype = "dashed", colour = "grey") +
  geom_point(aes(colour = experiment)) +
  ggrepel::geom_text_repel(aes(label = id_public), size = 2.5) +
  geom_text(data = corr_labels, aes(label = corr_label), hjust = 0, size = 2.5) +
  scale_colour_manual(values = c("steelblue", "brown")) +
  labs(x = "Branching plasticity\n(QTL experiment)", y = "Branching plasticity\n(Pulse experiment)") +
  coord_cartesian(xlim = c(-1.5, 8), ylim = c(-1.5, 8)) +
  facet_grid(~ experiment) +
  theme(legend.position = "none") 

p2 <- pulse_plas %>% 
  ggplot(aes(totalbr_pulse_ln - totalbr_qtl_ln, totalbr_pulse_hn - totalbr_qtl_hn)) +
  geom_vline(xintercept = 0, linetype = "dashed", colour = "grey") +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey") +
  geom_point(aes(colour = experiment)) +
  ggrepel::geom_text_repel(aes(label = id_public), size = 2.5) +
  scale_colour_manual(values = c("steelblue", "brown")) +
  labs(x = "LN\n(Pulse experiment - QTL experiment)", y = "HN\n(Pulse experiment - QTL experiment)") +
  coord_cartesian(xlim = c(-5.5, 5.5), ylim = c(-5.5, 5.5)) +
  theme(legend.position = "none") +
  facet_grid(~ experiment)

#pdf("./figures/figureS3.pdf", width = 7, height = 7)
p1 + ggtitle("A") +
  p2 + ggtitle("B") + plot_layout(widths = c(0.55, 0.45), ncol = 1)
#dev.off()
```

We can see that the flowering time was quite different, in particular for 
experiment 2, where everyone flowered later than in the QTL experiment:

```{r}
pulse_plas %>% 
  ggplot(aes(bolt_pulse_ln - bolt_qtl_ln, bolt_pulse_hn - bolt_qtl_hn)) +
  geom_vline(xintercept = 0, linetype = "dashed", colour = "grey") +
  geom_hline(yintercept = 0, linetype = "dashed", colour = "grey") +
  geom_point(aes(colour = experiment)) +
  ggrepel::geom_text_repel(aes(label = id_public), size = 2.5) +
  scale_colour_manual(values = c("steelblue", "brown")) +
  labs(x = "LN\n(Pulse experiment - QTL experiment)", y = "HN\n(Pulse experiment - QTL experiment)",
       subtitle = "Flowering time difference between experiments") +
  theme(legend.position = "none") +
  facet_grid(~ experiment)
```


# Fig 5 - Correlation between plasticity and response to a pulse

In both experiments there is a tentative positive, albeit statistically unconvincing, 
trend in that more plastic lines respond more to the pulse. 

```{r}
# Get correlation for labeling plots
corr_labels <- pulse_plas %>% 
  group_by(experiment) %>% 
  summarise(x = 1.5,
            y = 7,
            corr_label = corLabel(totalbr_pulse_pulse - totalbr_pulse_ln, totalbr_pulse_hn - totalbr_pulse_ln, TRUE))

# Make graph
#pdf("./figures/figure5.pdf", width = 7.5, height = 4)
pulse_plas %>% 
  mutate(x = totalbr_pulse_pulse - totalbr_pulse_ln,
         y =totalbr_pulse_hn - totalbr_pulse_ln) %>% 
  ggplot(aes(x, y)) +
  geom_abline(linetype = "dashed", colour = "grey") +
  geom_point() +
  geom_text(data = corr_labels, aes(label = corr_label), hjust = 0, size = 2.5) +
  facet_wrap(~ experiment) +
  ggrepel::geom_text_repel(aes(label = id_public), size = 2.5) +
  labs(x = "Branching plasticity\nPulse HN - LN", y = "Branching plasticity\nConstant HN - LN")
#dev.off()
```



# Session Info

```{r}
sessionInfo()
```

